<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice Extractor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress {
            height: 25px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h2 class="text-center mb-4">üßæ Invoice Data Extractor</h2>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="alert-messages mb-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'success' if category == 'success' else 'warning' }}" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form id="upload-form" method="POST" enctype="multipart/form-data" class="p-4 border bg-white shadow-sm rounded">
            <div class="mb-3">
                <label for="image" class="form-label">Upload Invoice Images</label>
                <input type="file" class="form-control" name="image" multiple required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Extract Fields</button>
            <div class="progress mt-3 d-none">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">Uploading...</div>
            </div>
        </form>

        {% if all_results %}
            <div class="mt-5">
                <h4>üìã Extracted Invoice Fields</h4>
                {% for result in all_results %}
                    <h5 class="mt-3">{{ result.filename }}</h5>
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr><th>Field</th><th>Value</th></tr>
                        </thead>
                        <tbody>
                            {% for key, value in result.fields.items() %}
                            <tr><td>{{ key }}</td><td>{{ value }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endfor %}

                <div class="d-flex gap-2 mt-3">
                    <a class="btn btn-success" href="{{ url_for('download_csv', filename=csv_filename) }}">
                        ‚¨áÔ∏è Download CSV
                    </a>

                    <form action="/append-to-existing" method="POST">
                        <input type="hidden" name="csv_filename" value="{{ csv_filename }}">
                        <button type="submit" class="btn btn-warning">üìé Append to invoices.csv</button>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        const form = document.getElementById('upload-form');
        const progressContainer = document.querySelector('.progress');
        const progressBar = document.querySelector('.progress-bar');

        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(form);
            progressContainer.classList.remove('d-none');
            progressBar.style.width = '0%';
            progressBar.textContent = 'Uploading...';

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/');

            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                }
            });

            xhr.onload = function() {
                if (xhr.status === 200) {
                    progressBar.textContent = 'Upload Complete';
                    document.open();
                    document.write(xhr.responseText);
                    document.close();
                } else {
                    progressBar.classList.add('bg-danger');
                    progressBar.textContent = 'Upload Failed';
                }
            };

            xhr.send(formData);
        });
    </script>
</body>
</html>
